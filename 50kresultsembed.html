<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiger Claw 50k - Live Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom styles for table */
        th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        /* Style for status */
        .status-active { color: #059669; font-weight: 500; } /* Emerald */
        .status-finished { color: #1d4ed8; font-weight: 500; } /* Blue */
        .status-dnf, .status-dns { color: #dc2626; font-weight: 500; } /* Red */
        /* Style for loops */
        .loop-pink { background-color: #fce7f3; color: #831843; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; }
        .loop-white { background-color: #f1f5f9; color: #1e293b; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; border: 1px solid #cbd5e1;}
        .loop-yellow { background-color: #fef9c3; color: #713f12; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; }
        /* Loading/Error Styles */
        #loadingMessage, #errorMessage { text-align: center; padding: 1rem; font-weight: 500; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; display: inline-block; margin: 0 auto 0.5rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Small text for timestamps */
        .time-small { font-size: 0.8rem; color: #6b7280; }
        /* Sticky header */
        thead th { position: sticky; top: 0; z-index: 10; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Tiger Claw 50k</h1>
        <p class="text-center text-gray-600 mb-4">Live Results</p>
        <p class="text-center text-xs text-gray-500 mb-6">Last Updated: <span id="lastUpdated">Never</span></p>

        <div id="loadingMessage" class="text-gray-600">
            <div class="spinner"></div>
            <div>Loading results...</div>
        </div>

        <div id="errorMessage" class="text-red-600 hidden">
            Error loading results. Please try refreshing the page.
            <pre id="errorDetails" class="text-xs text-left mt-2 bg-red-50 p-2 rounded"></pre>
        </div>

        <div id="resultsTableContainer" class="overflow-x-auto hidden">
            <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bib</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Seen</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Elapsed Time</th>
                    </tr>
                </thead>
                <tbody id="resultsBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // PASTE THE COPIED URL from "Publish to the web" (CSV format) for the '50k RESULTS' sheet here
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHGEvgy3yNGS0uV48XNrMGnbbZNorOFTx6YO0Q7dwrGkgvCkAYt2p6644uScSDqee14uVB8-0xhSGy/pub?gid=1613674231&single=true&output=csv';
        const REFRESH_INTERVAL_MS = 45 * 1000; // Refresh every 45 seconds
        // Column indices (0-based) in the published CSV data (adjust if your columns change!)
        const COL_BIB = 0;
        const COL_NAME = 1;
        const COL_STATUS = 2;
        const COL_GREEN_CP = 3;
        const COL_LOOP1_COLOR = 4;
        const COL_LOOP1_BOTTOM = 5;
        const COL_LOOP1_TOP = 6;
        const COL_LOOP1_ELAPSED = 7;
        // ... add indices for loop 2 and 3 columns (E=4 to S=18 -> indices 4 to 18)
        const COL_LOOP2_COLOR = 9;
        const COL_LOOP2_BOTTOM = 10;
        const COL_LOOP2_TOP = 11;
        const COL_LOOP2_ELAPSED = 12;
        const COL_LOOP3_COLOR = 14;
        const COL_LOOP3_BOTTOM = 15;
        const COL_LOOP3_TOP = 16;
        const COL_LOOP3_ELAPSED = 17;
        const COL_RED_CP = 19;
        const COL_FINISH_SCAN = 20;
        const COL_FINISH_ELAPSED = 21;
        // --- End Configuration ---

        const resultsBody = document.getElementById('resultsBody');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const resultsTableContainer = document.getElementById('resultsTableContainer');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        let refreshIntervalId = null;

        // Function to parse CSV data (simple version, assumes no commas within fields)
        function parseCSV(csvText) {
            if (!csvText || typeof csvText !== 'string') return [];
            const lines = csvText.trim().split('\n');
            // Skip header row (first line)
            return lines.slice(1).map(line => line.split(','));
        }

        // Function to format time from spreadsheet (assuming it's a valid date/time string)
        function formatTime(dateTimeString) {
            if (!dateTimeString || dateTimeString.trim() === "") return "";
            try {
                const date = new Date(dateTimeString);
                // Check if date is valid (specifically checking against the default 1899 date)
                if (isNaN(date.getTime()) || date.getFullYear() < 1900) return "";
                return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
            } catch (e) {
                console.error("Error formatting time:", dateTimeString, e);
                return "Invalid Time";
            }
        }

         // Function to format duration (assuming it's a fraction of a day)
        function formatDuration(durationString) {
             if (!durationString || isNaN(parseFloat(durationString)) || parseFloat(durationString) <= 0) return "";
             try {
                // Convert fraction of a day to milliseconds
                const totalMilliseconds = parseFloat(durationString) * 24 * 60 * 60 * 1000;
                if (totalMilliseconds <= 0) return "";

                const totalSeconds = Math.floor(totalMilliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } catch (e) {
                console.error("Error formatting duration:", durationString, e);
                return "Invalid Duration";
            }
        }

        // Function to determine status class
        function getStatusClass(status) {
            status = status.toUpperCase();
            if (status === 'FINISHED') return 'status-finished';
            if (status === 'DNF' || status === 'DNS') return 'status-dnf';
            if (status === 'ACTIVE') return 'status-active';
            return ''; // Default
        }

        // Function to create loop indicator span
        function createLoopSpan(color) {
            if (!color) return '';
            color = color.toUpperCase();
            let className = '';
            if (color === 'PINK') className = 'loop-pink';
            else if (color === 'WHITE') className = 'loop-white';
            else if (color === 'YELLOW') className = 'loop-yellow';
            else return ''; // Unknown color
            return `<span class="${className}">${color.substring(0,1)}</span>`; // Just show P, W, Y
        }

        // Function to update the results table
        function updateTable(data) {
            resultsBody.innerHTML = ''; // Clear existing rows
            if (!data || data.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No results data available yet.</td></tr>';
                return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');

                const bib = row[COL_BIB] || '';
                const name = row[COL_NAME] || '';
                const status = row[COL_STATUS] || 'Active'; // Default to Active if blank
                const finishElapsed = formatDuration(row[COL_FINISH_ELAPSED]);

                // Determine Progress and Last Seen
                let progressHtml = '';
                let lastSeenTime = '';
                let lastSeenCP = '';

                // Check finish first
                if (row[COL_FINISH_SCAN] && formatTime(row[COL_FINISH_SCAN])) {
                    lastSeenTime = formatTime(row[COL_FINISH_SCAN]);
                    lastSeenCP = 'Finish';
                    progressHtml = '<span class="text-green-600 font-semibold">FINISHED</span>';
                } else if (row[COL_RED_CP] && formatTime(row[COL_RED_CP])) {
                    lastSeenTime = formatTime(row[COL_RED_CP]);
                    lastSeenCP = 'Red CP';
                    progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])} ${createLoopSpan(row[COL_LOOP2_COLOR])} ${createLoopSpan(row[COL_LOOP3_COLOR])} <span class="text-red-600">Red</span>`;
                } else if (row[COL_LOOP3_TOP] && formatTime(row[COL_LOOP3_TOP])) {
                    lastSeenTime = formatTime(row[COL_LOOP3_TOP]);
                    lastSeenCP = `${row[COL_LOOP3_COLOR]} Top`;
                     progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])} ${createLoopSpan(row[COL_LOOP2_COLOR])} ${createLoopSpan(row[COL_LOOP3_COLOR])}`;
                } else if (row[COL_LOOP3_BOTTOM] && formatTime(row[COL_LOOP3_BOTTOM])) {
                    lastSeenTime = formatTime(row[COL_LOOP3_BOTTOM]);
                    lastSeenCP = `${row[COL_LOOP3_COLOR]} Bottom`;
                     progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])} ${createLoopSpan(row[COL_LOOP2_COLOR])} ${createLoopSpan(row[COL_LOOP3_COLOR])}`;
                } else if (row[COL_LOOP2_TOP] && formatTime(row[COL_LOOP2_TOP])) {
                    lastSeenTime = formatTime(row[COL_LOOP2_TOP]);
                    lastSeenCP = `${row[COL_LOOP2_COLOR]} Top`;
                     progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])} ${createLoopSpan(row[COL_LOOP2_COLOR])}`;
                } else if (row[COL_LOOP2_BOTTOM] && formatTime(row[COL_LOOP2_BOTTOM])) {
                    lastSeenTime = formatTime(row[COL_LOOP2_BOTTOM]);
                    lastSeenCP = `${row[COL_LOOP2_COLOR]} Bottom`;
                     progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])} ${createLoopSpan(row[COL_LOOP2_COLOR])}`;
                } else if (row[COL_LOOP1_TOP] && formatTime(row[COL_LOOP1_TOP])) {
                    lastSeenTime = formatTime(row[COL_LOOP1_TOP]);
                    lastSeenCP = `${row[COL_LOOP1_COLOR]} Top`;
                     progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])}`;
                } else if (row[COL_LOOP1_BOTTOM] && formatTime(row[COL_LOOP1_BOTTOM])) {
                    lastSeenTime = formatTime(row[COL_LOOP1_BOTTOM]);
                    lastSeenCP = `${row[COL_LOOP1_COLOR]} Bottom`;
                     progressHtml = `${createLoopSpan(row[COL_LOOP1_COLOR])}`;
                } else if (row[COL_GREEN_CP] && formatTime(row[COL_GREEN_CP])) {
                    lastSeenTime = formatTime(row[COL_GREEN_CP]);
                    lastSeenCP = 'Green CP';
                    progressHtml = '<span class="text-green-500">Green</span>';
                } else {
                    lastSeenTime = '';
                    lastSeenCP = 'Not Started';
                    progressHtml = '-';
                }


                tr.innerHTML = `
                    <td>${bib}</td>
                    <td>${name}</td>
                    <td><span class="${getStatusClass(status)}">${status}</span></td>
                    <td>${progressHtml}</td>
                    <td>${lastSeenCP}<br><span class="time-small">${lastSeenTime}</span></td>
                    <td>${finishElapsed}</td>
                `;
                resultsBody.appendChild(tr);
            });
        }

        // Function to fetch and update data
        async function fetchData() {
            console.log("Fetching data...");
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            resultsTableContainer.classList.add('hidden'); // Hide table while loading

            if (!SPREADSHEET_URL || SPREADSHEET_URL === 'YOUR_PUBLISHED_50K_RESULTS_CSV_URL_HERE') {
                 console.error("Spreadsheet URL is not configured.");
                 errorMessage.textContent = "Error: Spreadsheet URL not configured in the code.";
                 errorDetails.textContent = "";
                 errorMessage.classList.remove('hidden');
                 loadingMessage.classList.add('hidden');
                 return;
            }

            try {
                // Add cache buster to URL to prevent browser caching
                const url = `${SPREADSHEET_URL}&t=${Date.now()}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }

                const csvData = await response.text();
                const parsedData = parseCSV(csvData);

                updateTable(parsedData);

                // Show table, hide messages
                resultsTableContainer.classList.remove('hidden');
                loadingMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');
                lastUpdatedElement.textContent = new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error fetching or processing data:', error);
                loadingMessage.classList.add('hidden');
                resultsTableContainer.classList.add('hidden');
                errorMessage.textContent = "Error loading results. Please try refreshing the page.";
                errorDetails.textContent = `Details: ${error.message}`; // Show specific error
                errorMessage.classList.remove('hidden');
                // Stop refreshing if there's an error
                if (refreshIntervalId) {
                    clearInterval(refreshIntervalId);
                    refreshIntervalId = null;
                }
            }
        }

        // Initial data fetch
        fetchData();

        // Set up auto-refresh
        if (REFRESH_INTERVAL_MS > 0) {
             refreshIntervalId = setInterval(fetchData, REFRESH_INTERVAL_MS);
             console.log(`Auto-refresh enabled every ${REFRESH_INTERVAL_MS / 1000} seconds.`);
        }

    </script>

</body>
</html>
