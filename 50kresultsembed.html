<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiger Claw Live Results (Unofficial)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Common table styles */
        th, td { padding: 0.5rem 0.5rem; text-align: left; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #f3f4f6; white-space: nowrap; }
        th:last-child, td:last-child { border-right: none; }
        th { background-color: #f9fafb; font-weight: 600; user-select: none; }
        th[data-sort] { cursor: pointer; }
        th .sort-icon { display: inline-block; width: 1em; height: 1em; margin-left: 0.3em; opacity: 0.3; vertical-align: middle;}
        th.sort-asc .sort-icon::after { content: ' ▲'; }
        th.sort-desc .sort-icon::after { content: ' ▼'; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #f0f9ff; }
        /* Status/Loop styles */
        .status-active { color: #059669; font-weight: 500; } .status-finished { color: #1d4ed8; font-weight: 500; } .status-dnf, .status-dns { color: #dc2626; font-weight: 500; }
        .loop-pink { background-color: #fce7f3; color: #831843; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; }
        .loop-white { background-color: #f1f5f9; color: #1e293b; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; border: 1px solid #cbd5e1;}
        .loop-yellow { background-color: #fef9c3; color: #713f12; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; }
        /* Utility styles */
        #loadingMessage, #errorMessage { text-align: center; padding: 1rem; font-weight: 500; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 1em; height: 1em; /* Smaller spinner */ animation: spin 1s linear infinite; display: inline-block; margin: 0 0.5rem; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #f9fafb; }
        .hidden { display: none; }
        /* Tab styles */
        .tab-button { padding: 0.5rem 1rem; margin-right: 0.5rem; border: 1px solid transparent; border-bottom: none; border-radius: 0.375rem 0.375rem 0 0; cursor: pointer; background-color: #e5e7eb; color: #4b5563; }
        .tab-button.active { background-color: white; color: #1f2937; border-color: #e5e7eb; font-weight: 600; }
        .tab-content { border: 1px solid #e5e7eb; border-top: none; padding-top: 1rem; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-1">Tiger Claw Live Results</h1>
        <p class="text-lg text-center text-gray-600 mb-4">(Unofficial)</p>
        <p class="text-center text-xs text-gray-500 mb-6">
            Last Updated: <span id="lastUpdated">Never</span>
            <span id="loadingSpinner" class="spinner hidden"></span> </p>

        <div class="mb-4 border-b border-gray-200">
            <nav class="-mb-px flex space-x-1" aria-label="Tabs">
                <button id="tabButton50k" type="button" class="tab-button active" data-target="results50k">50k</button>
                <button id="tabButtonAscent" type="button" class="tab-button" data-target="resultsAscent">Ascent</button>
            </nav>
        </div>

        <div class="mb-4">
            <label for="searchInput" class="sr-only">Search by Bib or Name:</label>
            <input type="text" id="searchInput" placeholder="Search by Bib or Name..." class="w-full md:w-1/2 lg:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <div id="loadingMessage" class="text-gray-600">
             <div>Loading initial results...</div>
        </div>
        <div id="errorMessage" class="text-red-600 hidden">
            Error loading results. Please try refreshing the page.
            <pre id="errorDetails" class="text-xs text-left mt-2 bg-red-50 p-2 rounded"></pre>
        </div>

        <div id="tabContent">
            <div id="results50k" class="tab-content">
                <div id="resultsTableContainer50k" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="bib">Bib<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="name">Name<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="status">Status<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="green_cp">Green CP<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lp 1</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L1 Bot</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L1 Top</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L1 Elapsed</th> <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D1 Elapsed</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lp 2</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L2 Bot</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L2 Top</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L2 Elapsed</th> <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D2 Elapsed</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lp 3</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L3 Bot</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L3 Top</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L3 Elapsed</th> <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D3 Elapsed</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="red_cp">Red CP<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="finish_scan">Finish Scan<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="finish_elapsed">Total Time<span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody50k" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 <p id="rowCount50k" class="text-xs text-gray-500 mt-2"></p>
            </div>

             <div id="resultsAscent" class="tab-content hidden">
                 <div id="resultsTableContainerAscent" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="bib">Bib<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="name">Name<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="status">Status<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="finish_scan">Finish Scan<span class="sort-icon"></span></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="finish_elapsed">Elapsed Time<span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody id="resultsBodyAscent" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 <p id="rowCountAscent" class="text-xs text-gray-500 mt-2"></p>
            </div>
        </div>

    </div>

    <script>
        // --- Configuration ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznjmZnmSIhxIjpcAey4veFhYiP7-KR5lnbBR8VfkrwrOxk_lIzZ31BK62AvdAmli8/exec'; // <-- URL for Tiger Claw Scan Receiver Script
        // ****** UPDATED CSV URLs ******
        const RESULTS_50K_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHGEvgy3yNGS0uV48XNrMGnbbZNorOFTx6YO0Q7dwrGkgvCkAYt2p6644uScSDqee14uVB8-0xhSGy/pub?gid=1613674231&single=true&output=csv';
        const RESULTS_ASCENT_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHGEvgy3yNGS0uV48XNrMGnbbZNorOFTx6YO0Q7dwrGkgvCkAYt2p6644uScSDqee14uVB8-0xhSGy/pub?gid=619464822&single=true&output=csv';
        // *****************************
        const REFRESH_INTERVAL_MS = 45 * 1000;
        const RACE_START_TIME_50K_MS = Date.UTC(2025, 3, 30, 14, 0, 0); // May 10, 2025 7:00 AM PST
        const RACE_START_TIME_ASCENT_MS = Date.UTC(2025, 3, 28, 18 + 7, 0, 0); // May 9, 2025 6:00 PM PST (Assuming PST is UTC-7)

        const COL_50K = { BIB: 0, NAME: 1, STATUS: 2, GREEN_CP: 3, LOOP1_COLOR: 4, LOOP1_BOTTOM: 5, LOOP1_TOP: 6, LOOP1_ELAPSED: 7, DESC1_ELAPSED: 8, LOOP2_COLOR: 9, LOOP2_BOTTOM: 10, LOOP2_TOP: 11, LOOP2_ELAPSED: 12, DESC2_ELAPSED: 13, LOOP3_COLOR: 14, LOOP3_BOTTOM: 15, LOOP3_TOP: 16, LOOP3_ELAPSED: 17, DESC3_ELAPSED: 18, RED_CP: 19, FINISH_SCAN: 20, FINISH_ELAPSED: 21 };
        const COL_ASCENT = { BIB: 0, NAME: 1, STATUS: 2, FINISH_SCAN: 3, FINISH_ELAPSED: 4 };
        // --- End Configuration ---

        const resultsBody50k = document.getElementById('resultsBody50k');
        const resultsBodyAscent = document.getElementById('resultsBodyAscent');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const resultsTableContainer50k = document.getElementById('resultsTableContainer50k');
        const resultsTableContainerAscent = document.getElementById('resultsTableContainerAscent');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const searchInput = document.getElementById('searchInput');
        const rowCount50kElement = document.getElementById('rowCount50k');
        const rowCountAscentElement = document.getElementById('rowCountAscent');
        const tableHeaders50k = document.querySelectorAll('#resultsTableContainer50k th[data-sort]');
        const tableHeadersAscent = document.querySelectorAll('#resultsTableContainerAscent th[data-sort]');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const tabButton50k = document.getElementById('tabButton50k');
        const tabButtonAscent = document.getElementById('tabButtonAscent');
        const results50kDiv = document.getElementById('results50k');
        const resultsAscentDiv = document.getElementById('resultsAscent');

        let refreshIntervalId = null;
        let all50kData = []; let allAscentData = [];
        let calculated50kData = []; let calculatedAscentData = [];
        let all50kRunnerBibs = new Set(); let allAscentRunnerBibs = new Set();
        let dualRunnerBibs = new Set();
        let currentSort = { column: 'bib', direction: 'asc' };
        let currentFilter = '';
        let isFetching = false;
        let activeTab = '50k';

        // --- Utility Functions ---
        function parseCSV(csvText) { if (!csvText || typeof csvText !== 'string') return []; const lines = csvText.trim().split('\n'); return lines.slice(1).map(line => line.split(',').map(field => field.trim())); }
        function formatTime(dateTimeString) { if (!dateTimeString || dateTimeString.trim() === "") return ""; try { const date = new Date(dateTimeString); if (isNaN(date.getTime()) || date.getFullYear() < 1900) return ""; return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' }); } catch (e) { return ""; } }
        function formatMillisecondsToDuration(ms) { if (ms === undefined || ms === null || isNaN(Number(ms)) || Number(ms) < 0) return ""; try { const totalMilliseconds = Number(ms); if (totalMilliseconds < 500) return "00:00:00"; const totalSeconds = Math.floor(totalMilliseconds / 1000); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; } catch (e) { console.error("Error formatting milliseconds:", ms, e); return "Invalid"; } }
        // Format duration FROM CSV (handles numeric fraction or HH:MM:SS string)
        function formatDurationFromCSV(durationInput) { if (durationInput === undefined || durationInput === null) return ""; const durationString = String(durationInput).trim(); if (durationString === "" || durationString.startsWith('-')) { return ""; } const numericValue = parseFloat(durationString); if (!isNaN(numericValue) && numericValue > 0 && numericValue < 10) { try { const ms = numericValue * 24 * 60 * 60 * 1000; return formatMillisecondsToDuration(ms); } catch (e) { return "Invalid"; } } else if (/^\d{1,3}:\d{2}:\d{2}(\.\d+)?$/.test(durationString)) { try { const parts = durationString.split(':'); const h = String(parts[0] || '0').padStart(2, '0'); const m = String(parts[1] || '0').padStart(2, '0'); const s = String(Math.floor(parseFloat(parts[2] || '0'))).padStart(2, '0'); return `${h}:${m}:${s}`; } catch(e) { return "Invalid"; } } else { return ""; } }
        function getStatusClass(status) { status = status.toUpperCase(); if (status === 'FINISHED') return 'status-finished'; if (status === 'DNF' || status === 'DNS') return 'status-dnf'; if (status === 'ACTIVE') return 'status-active'; return ''; }
        function createLoopSpan(color) { if (!color) return ''; color = color.toUpperCase(); let className = ''; if (color === 'PINK') className = 'loop-pink'; else if (color === 'WHITE') className = 'loop-white'; else if (color === 'YELLOW') className = 'loop-yellow'; else return ''; return `<span class="${className}">${color.substring(0,1)}</span>`; }
        function getTimeMs(dateString) { if (!dateString) return null; try { const date = new Date(dateString); return isNaN(date.getTime()) ? null : date.getTime(); } catch { return null; } }

        // --- Data Processing Functions ---
        function processData(rawData, raceType) {
             console.log(`Processing ${raceType} raw data...`);
             const COL_MAP = raceType === '50k' ? COL_50K : COL_ASCENT;
             const START_TIME = raceType === '50k' ? RACE_START_TIME_50K_MS : RACE_START_TIME_ASCENT_MS;

             return rawData.map(row => {
                const bib = row[COL_MAP.BIB] || '';
                const processed = [...row]; // Create a mutable copy
                const finishScanMs = getTimeMs(row[COL_MAP.FINISH_SCAN]); // Get finish time in ms

                // Calculate total elapsed time in ms
                let totalElapsedMs = null;
                if (finishScanMs && finishScanMs > START_TIME) {
                    totalElapsedMs = finishScanMs - START_TIME;
                }
                // Store calculated ms at the correct index for this race type
                processed[COL_MAP.FINISH_ELAPSED] = totalElapsedMs;

                // Only calculate loop times for 50k
                if (raceType === '50k') {
                    const l1BotMs = getTimeMs(row[COL_MAP.LOOP1_BOTTOM]); const l1TopMs = getTimeMs(row[COL_MAP.LOOP1_TOP]);
                    const l2BotMs = getTimeMs(row[COL_MAP.LOOP2_BOTTOM]); const l2TopMs = getTimeMs(row[COL_MAP.LOOP2_TOP]);
                    const l3BotMs = getTimeMs(row[COL_MAP.LOOP3_BOTTOM]); const l3TopMs = getTimeMs(row[COL_MAP.LOOP3_TOP]);
                    const redCpMs = getTimeMs(row[COL_MAP.RED_CP]);

                    processed[COL_MAP.LOOP1_ELAPSED] = (l1BotMs && l1TopMs && l1TopMs > l1BotMs) ? (l1TopMs - l1BotMs) : null;
                    processed[COL_MAP.DESC1_ELAPSED] = (l1TopMs && l2BotMs && l2BotMs > l1TopMs) ? (l2BotMs - l1TopMs) : null;
                    processed[COL_MAP.LOOP2_ELAPSED] = (l2BotMs && l2TopMs && l2TopMs > l2BotMs) ? (l2TopMs - l2BotMs) : null;
                    processed[COL_MAP.DESC2_ELAPSED] = (l2TopMs && l3BotMs && l3BotMs > l2TopMs) ? (l3BotMs - l2TopMs) : null;
                    processed[COL_MAP.LOOP3_ELAPSED] = (l3BotMs && l3TopMs && l3TopMs > l3BotMs) ? (l3TopMs - l3BotMs) : null;
                    processed[COL_MAP.DESC3_ELAPSED] = (l3TopMs && redCpMs && redCpMs > l3TopMs) ? (redCpMs - l3TopMs) : null;
                }
                return processed;
            });
        }

        function identifyDualRunners() { /* ... same as before ... */ dualRunnerBibs.clear(); if (all50kRunnerBibs.size > 0 && allAscentRunnerBibs.size > 0) { all50kRunnerBibs.forEach(bib => { if (allAscentRunnerBibs.has(bib)) { dualRunnerBibs.add(bib); } }); } console.log(`Identified ${dualRunnerBibs.size} dual runners.`); }
        function filterAndSortData() { const sourceData = (activeTab === '50k') ? calculated50kData : calculatedAscentData; const cols = (activeTab === '50k') ? COL_50K : COL_ASCENT; let filteredData = sourceData; if (currentFilter) { const lowerCaseFilter = currentFilter.toLowerCase(); filteredData = sourceData.filter(row => { const bib = String(row[cols.BIB] || '').toLowerCase(); const name = String(row[cols.NAME] || '').toLowerCase(); return bib.includes(lowerCaseFilter) || name.includes(lowerCaseFilter); }); } const { column, direction } = currentSort; const sortMultiplier = direction === 'asc' ? 1 : -1; const sortColIndex = cols[column.toUpperCase()]; if (sortColIndex === undefined) { console.warn(`Sort column ${column} not found for ${activeTab}, defaulting to bib.`); currentSort.column = 'bib'; return filterAndSortData(); } filteredData.sort((a, b) => { let valA = a[sortColIndex]; let valB = b[sortColIndex]; if (column === 'bib') { valA = parseInt(valA || '0', 10); valB = parseInt(valB || '0', 10); } else if (column.includes('_cp') || column.includes('_scan')) { valA = getTimeMs(valA) ?? (direction === 'asc' ? Infinity : -Infinity); valB = getTimeMs(valB) ?? (direction === 'asc' ? Infinity : -Infinity); } else if (column.includes('_elapsed')) { valA = valA ?? (direction === 'asc' ? Infinity : -Infinity); valB = valB ?? (direction === 'asc' ? Infinity : -Infinity); } else { valA = String(valA || '').toLowerCase(); valB = String(valB || '').toLowerCase(); } if (valA < valB) return -1 * sortMultiplier; if (valA > valB) return 1 * sortMultiplier; return 0; }); return filteredData; }

        // --- UI Update Functions ---
        function updateTable() {
            const displayData = filterAndSortData();
            const is50k = activeTab === '50k';
            const tableBody = is50k ? resultsBody50k : resultsBodyAscent;
            const rowCountEl = is50k ? rowCount50kElement : rowCountAscentElement;
            const cols = is50k ? COL_50K : COL_ASCENT;
            const totalDataLength = is50k ? calculated50kData.length : calculatedAscentData.length;

            tableBody.innerHTML = '';
            if (!displayData || displayData.length === 0) { const colspan = is50k ? 22 : 5; tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-gray-500 py-4">${currentFilter ? 'No matching runners found.' : 'No results data available yet.'}</td></tr>`; rowCountEl.textContent = `Showing 0 runners`; return; }

            displayData.forEach(row => {
                const tr = document.createElement('tr');
                const bib = row[cols.BIB] || '';
                const name = row[cols.NAME] || '';
                const isDual = dualRunnerBibs.has(bib);
                const nameHtml = `${name}${isDual ? ' <span title="Participated in both events">🐅</span>' : ''}`;

                if (is50k) {
                    tr.innerHTML = `
                        <td>${bib}</td><td>${nameHtml}</td><td><span class="${getStatusClass(row[cols.STATUS] || 'Active')}">${row[cols.STATUS] || 'Active'}</span></td>
                        <td>${formatTime(row[cols.GREEN_CP])}</td><td>${createLoopSpan(row[cols.LOOP1_COLOR])}</td><td>${formatTime(row[cols.LOOP1_BOTTOM])}</td>
                        <td>${formatTime(row[cols.LOOP1_TOP])}</td><td>${formatMillisecondsToDuration(row[cols.LOOP1_ELAPSED], 'LOOP1_ELAPSED')}</td><td>${formatMillisecondsToDuration(row[cols.DESC1_ELAPSED], 'DESC1_ELAPSED')}</td>
                        <td>${createLoopSpan(row[cols.LOOP2_COLOR])}</td><td>${formatTime(row[cols.LOOP2_BOTTOM])}</td><td>${formatTime(row[cols.LOOP2_TOP])}</td>
                        <td>${formatMillisecondsToDuration(row[cols.LOOP2_ELAPSED], 'LOOP2_ELAPSED')}</td><td>${formatMillisecondsToDuration(row[cols.DESC2_ELAPSED], 'DESC2_ELAPSED')}</td>
                        <td>${createLoopSpan(row[cols.LOOP3_COLOR])}</td><td>${formatTime(row[cols.LOOP3_BOTTOM])}</td><td>${formatTime(row[cols.LOOP3_TOP])}</td>
                        <td>${formatMillisecondsToDuration(row[cols.LOOP3_ELAPSED], 'LOOP3_ELAPSED')}</td><td>${formatMillisecondsToDuration(row[cols.DESC3_ELAPSED], 'DESC3_ELAPSED')}</td>
                        <td>${formatTime(row[cols.RED_CP])}</td><td>${formatTime(row[cols.FINISH_SCAN])}</td><td>${formatMillisecondsToDuration(row[cols.FINISH_ELAPSED], 'FINISH_ELAPSED')}</td>
                    `;
                } else { // Ascent
                     tr.innerHTML = `
                        <td>${bib}</td><td>${nameHtml}</td><td><span class="${getStatusClass(row[cols.STATUS] || 'Active')}">${row[cols.STATUS] || 'Active'}</span></td>
                        <td>${formatTime(row[cols.FINISH_SCAN])}</td><td>${formatMillisecondsToDuration(row[cols.FINISH_ELAPSED], 'FINISH_ELAPSED')}</td>
                    `;
                }
                tableBody.appendChild(tr);
            });
             rowCountEl.textContent = `Showing ${displayData.length} of ${totalDataLength} runners`;
        }

        function updateSortIcons() { const headers = (activeTab === '50k') ? tableHeaders50k : tableHeadersAscent; headers.forEach(th => { const sortKey = th.getAttribute('data-sort'); th.classList.remove('sort-asc', 'sort-desc'); const iconSpan = th.querySelector('.sort-icon'); if (iconSpan) iconSpan.textContent = ''; if (sortKey === currentSort.column) { th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc'); if (iconSpan) iconSpan.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼'; } }); }

        // --- Event Handlers ---
        function handleSortClick(event) { const clickedHeader = event.currentTarget; const sortKey = clickedHeader.getAttribute('data-sort'); if (!sortKey) return; if (currentSort.column === sortKey) { currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; } else { currentSort.column = sortKey; currentSort.direction = 'asc'; } console.log(`Sorting by ${currentSort.column}, direction ${currentSort.direction}`); updateTable(); updateSortIcons(); }
        function handleFilterInput() { currentFilter = searchInput.value.trim(); console.log(`Filtering by: ${currentFilter}`); updateTable(); }
        function handleTabClick(event) { const clickedTab = event.currentTarget; const targetId = clickedTab.getAttribute('data-target'); tabButton50k.classList.toggle('active', targetId === 'results50k'); tabButtonAscent.classList.toggle('active', targetId === 'resultsAscent'); results50kDiv.classList.toggle('hidden', targetId !== 'results50k'); resultsAscentDiv.classList.toggle('hidden', targetId !== 'resultsAscent'); activeTab = (targetId === 'results50k') ? '50k' : 'Ascent'; console.log(`Switched to tab: ${activeTab}`); updateTable(); updateSortIcons(); }

        // --- Data Fetching ---
        // (fetchAllData remains the same)
        async function fetchAllData() { if (isFetching) { console.log("Fetch already in progress."); return; } isFetching = true; console.log("Fetching all data..."); if (loadingSpinner) loadingSpinner.classList.remove('hidden'); errorMessage.classList.add('hidden'); if (!RESULTS_50K_CSV_URL || RESULTS_50K_CSV_URL === 'YOUR_PUBLISHED_50K_RESULTS_CSV_URL_HERE' || !RESULTS_ASCENT_CSV_URL || RESULTS_ASCENT_CSV_URL === 'YOUR_PUBLISHED_ASCENT_RESULTS_CSV_URL_HERE' || !APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'PASTE_APPS_SCRIPT_DEPLOYMENT_URL_HERE') { console.error("One or more URLs are not configured."); errorMessage.textContent = "Error: Required URLs not configured."; errorDetails.textContent = ""; errorMessage.classList.remove('hidden'); loadingMessage.classList.add('hidden'); resultsTableContainer50k.classList.add('hidden'); resultsTableContainerAscent.classList.add('hidden'); isFetching = false; if (loadingSpinner) loadingSpinner.classList.add('hidden'); return; } try { const [res50k, resAscent, runners50kRes, runnersAscentRes] = await Promise.allSettled([ fetch(`${RESULTS_50K_CSV_URL}&t=${Date.now()}`), fetch(`${RESULTS_ASCENT_CSV_URL}&t=${Date.now()}`), fetch(`${APPS_SCRIPT_URL}?action=getRunners&race=50k&t=${Date.now()}`), fetch(`${APPS_SCRIPT_URL}?action=getRunners&race=Ascent&t=${Date.now()}`) ]); if (res50k.status === 'fulfilled' && res50k.value.ok) { const csvData = await res50k.value.text(); all50kData = parseCSV(csvData); calculated50kData = processData(all50kData, '50k'); } else { console.error("Failed to fetch 50k results:", res50k.reason || res50k.value.statusText); errorMessage.textContent = "Error loading 50k results. Displaying previous data if available."; errorMessage.classList.remove('hidden'); } if (resAscent.status === 'fulfilled' && resAscent.value.ok) { const csvData = await resAscent.value.text(); allAscentData = parseCSV(csvData); calculatedAscentData = processData(allAscentData, 'Ascent'); } else { console.error("Failed to fetch Ascent results:", resAscent.reason || resAscent.value.statusText); errorMessage.textContent = "Error loading Ascent results. Displaying previous data if available."; errorMessage.classList.remove('hidden'); } if (runners50kRes.status === 'fulfilled' && runners50kRes.value.ok) { const data = await runners50kRes.value.json(); if (data.status === 'success' && Array.isArray(data.runners)) { all50kRunnerBibs = new Set(data.runners.map(r => r.bib)); } else { console.error("Invalid 50k runner list data format"); } } else { console.error("Failed to fetch 50k runner list:", runners50kRes.reason || runners50kRes.value.statusText); } if (runnersAscentRes.status === 'fulfilled' && runnersAscentRes.value.ok) { const data = await runnersAscentRes.value.json(); if (data.status === 'success' && Array.isArray(data.runners)) { allAscentRunnerBibs = new Set(data.runners.map(r => r.bib)); } else { console.error("Invalid Ascent runner list data format"); } } else { console.error("Failed to fetch Ascent runner list:", runnersAscentRes.reason || runnersAscentRes.value.statusText); } identifyDualRunners(); updateTable(); updateSortIcons(); resultsTableContainer50k.classList.remove('hidden'); resultsTableContainerAscent.classList.remove('hidden'); loadingMessage.classList.add('hidden'); if (res50k.status === 'fulfilled' && resAscent.status === 'fulfilled' && runners50kRes.status === 'fulfilled' && runnersAscentRes.status === 'fulfilled') { errorMessage.classList.add('hidden'); } lastUpdatedElement.textContent = new Date().toLocaleTimeString(); } catch (error) { console.error('Error fetching/processing data:', error); errorMessage.textContent = "Error loading results. Displaying previous data."; errorDetails.textContent = `Details: ${error.message}`; errorMessage.classList.remove('hidden'); if (resultsTableContainer50k.classList.contains('hidden') && resultsTableContainerAscent.classList.contains('hidden')) { loadingMessage.classList.remove('hidden'); } } finally { isFetching = false; if (loadingSpinner) loadingSpinner.classList.add('hidden'); } }

        // --- Initial Setup ---
        searchInput.addEventListener('input', handleFilterInput);
        tableHeaders50k.forEach(th => th.addEventListener('click', handleSortClick));
        tableHeadersAscent.forEach(th => th.addEventListener('click', handleSortClick));
        tabButton50k.addEventListener('click', handleTabClick);
        tabButtonAscent.addEventListener('click', handleTabClick);
        fetchAllData(); // Initial fetch
        if (REFRESH_INTERVAL_MS > 0) { refreshIntervalId = setInterval(fetchAllData, REFRESH_INTERVAL_MS); console.log(`Auto-refresh enabled every ${REFRESH_INTERVAL_MS / 1000} seconds.`); }

    </script>

</body>
</html>
