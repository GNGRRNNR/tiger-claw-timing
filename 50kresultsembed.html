<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Tiger Claw 50k Live Results (Unofficial)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        th, td { padding: 0.5rem 0.5rem; text-align: left; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #f3f4f6; white-space: nowrap; }
        th:last-child, td:last-child { border-right: none; }
        th { background-color: #f9fafb; font-weight: 600; user-select: none; }
        th[data-sort] { cursor: pointer; }
        th .sort-icon { display: inline-block; width: 1em; height: 1em; margin-left: 0.3em; opacity: 0.3; vertical-align: middle;}
        th.sort-asc .sort-icon::after { content: ' ▲'; }
        th.sort-desc .sort-icon::after { content: ' ▼'; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #f0f9ff; }
        .status-active { color: #059669; font-weight: 500; } .status-finished { color: #1d4ed8; font-weight: 500; } .status-dnf, .status-dns { color: #dc2626; font-weight: 500; }
        .loop-pink { background-color: #fce7f3; color: #831843; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; }
        .loop-white { background-color: #f1f5f9; color: #1e293b; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; border: 1px solid #cbd5e1;}
        .loop-yellow { background-color: #fef9c3; color: #713f12; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-block; margin: 0.1rem; }
        #loadingMessage { text-align: center; padding: 1rem; font-weight: 500; }
        #errorMessage { text-align: center; padding: 1rem; font-weight: 500; color: #dc2626; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 1em; height: 1em; animation: spin 1s linear infinite; display: inline-block; margin: 0 0.5rem; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .time-small { font-size: 0.8rem; color: #6b7280; }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #f9fafb; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-1">2025 Tiger Claw 50k</h1>
        <p class="text-lg text-center text-gray-600 mb-4">Live Results (Unofficial)</p>
        <p class="text-center text-xs text-gray-500 mb-6">
            Last Updated: <span id="lastUpdated">Never</span>
            <span id="loadingSpinner" class="spinner hidden"></span> </p>

        <div class="mb-4">
            <label for="searchInput" class="sr-only">Search by Bib or Name:</label>
            <input type="text" id="searchInput" placeholder="Search by Bib or Name..." class="w-full md:w-1/2 lg:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <div id="loadingMessage" class="text-gray-600">
             <div>Loading initial results...</div>
        </div>
        <div id="errorMessage" class="text-red-600 hidden">
            Error loading results. Please try refreshing the page.
            <pre id="errorDetails" class="text-xs text-left mt-2 bg-red-50 p-2 rounded"></pre>
        </div>

        <div id="resultsTableContainer" class="overflow-x-auto hidden"> <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="bib">Bib<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="name">Name<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="status">Status<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="green_cp">Green CP<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lp 1</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L1 Bot</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L1 Top</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="loop1_elapsed">L1 Elapsed<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D1 Elapsed</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lp 2</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L2 Bot</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L2 Top</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="loop2_elapsed">L2 Elapsed<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D2 Elapsed</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lp 3</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L3 Bot</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L3 Top</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="loop3_elapsed">L3 Elapsed<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D3 Elapsed</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="red_cp">Red CP<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="finish_scan">Finish Scan<span class="sort-icon"></span></th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="finish_elapsed">Total Time<span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody id="resultsBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
         <p id="rowCount" class="text-xs text-gray-500 mt-2"></p>
    </div>

    <script>
        // --- Configuration ---
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHGEvgy3yNGS0uV48XNrMGnbbZNorOFTx6YO0Q7dwrGkgvCkAYt2p6644uScSDqee14uVB8-0xhSGy/pub?gid=1613674231&single=true&output=csv';
        const REFRESH_INTERVAL_MS = 45 * 1000;
        const RACE_START_TIME_MS = Date.UTC(2025, 4, 10, 14, 0, 0); // May 10, 2025 7:00 AM PST
        // Define COL indices based on the *original* spreadsheet structure
        // The calculatedData array will mirror this structure, storing ms where durations were
        const COL = { BIB: 0, NAME: 1, STATUS: 2, GREEN_CP: 3,
                      LOOP1_COLOR: 4, LOOP1_BOTTOM: 5, LOOP1_TOP: 6, LOOP1_ELAPSED: 7, DESC1_ELAPSED: 8,
                      LOOP2_COLOR: 9, LOOP2_BOTTOM: 10, LOOP2_TOP: 11, LOOP2_ELAPSED: 12, DESC2_ELAPSED: 13,
                      LOOP3_COLOR: 14, LOOP3_BOTTOM: 15, LOOP3_TOP: 16, LOOP3_ELAPSED: 17, DESC3_ELAPSED: 18,
                      RED_CP: 19, FINISH_SCAN: 20, FINISH_ELAPSED: 21 };
        // --- End Configuration ---

        const resultsBody = document.getElementById('resultsBody');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const resultsTableContainer = document.getElementById('resultsTableContainer');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const searchInput = document.getElementById('searchInput');
        const rowCountElement = document.getElementById('rowCount');
        const tableHeaders = document.querySelectorAll('#resultsTableContainer th[data-sort]');
        const loadingSpinner = document.getElementById('loadingSpinner');

        let refreshIntervalId = null;
        let allData = []; // Stores raw CSV rows
        let calculatedData = []; // Stores processed data with calculated times
        let currentSort = { column: 'bib', direction: 'asc' };
        let currentFilter = '';
        let isFetching = false;

        // --- Utility Functions ---
        function parseCSV(csvText) { if (!csvText || typeof csvText !== 'string') return []; const lines = csvText.trim().split('\n'); return lines.slice(1).map(line => line.split(',').map(field => field.trim())); }
        function formatTime(dateTimeString) { if (!dateTimeString || dateTimeString.trim() === "") return ""; try { const date = new Date(dateTimeString); if (isNaN(date.getTime()) || date.getFullYear() < 1900) return ""; return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' }); } catch (e) { return ""; } }
        function formatMillisecondsToDuration(ms, columnName = "Unknown") {
            // console.log(`Formatting MS - Column: ${columnName}, Input: ${ms}, Type: ${typeof ms}`); // Keep for debugging
            if (ms === undefined || ms === null || isNaN(Number(ms)) || Number(ms) < 0) { return ""; }
            try {
                const totalMilliseconds = Number(ms);
                if (totalMilliseconds < 500) { return "00:00:00"; }
                const totalSeconds = Math.floor(totalMilliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const formatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                // console.log(` -> Formatted: ${formatted}`);
                return formatted;
            } catch (e) { console.error(`Error formatting milliseconds for ${columnName}:`, ms, e); return "Invalid"; }
        }
        function getStatusClass(status) { status = status.toUpperCase(); if (status === 'FINISHED') return 'status-finished'; if (status === 'DNF' || status === 'DNS') return 'status-dnf'; if (status === 'ACTIVE') return 'status-active'; return ''; }
        function createLoopSpan(color) { if (!color) return ''; color = color.toUpperCase(); let className = ''; if (color === 'PINK') className = 'loop-pink'; else if (color === 'WHITE') className = 'loop-white'; else if (color === 'YELLOW') className = 'loop-yellow'; else return ''; return `<span class="${className}">${color.substring(0,1)}</span>`; }
        function getTimeMs(dateString) { if (!dateString) return null; try { const date = new Date(dateString); return isNaN(date.getTime()) ? null : date.getTime(); } catch { return null; } }

        // --- Data Processing Functions ---
        // (processData remains the same - calculates ms values)
        function processData(rawData) {
            console.log("Processing raw data into calculated data...");
            return rawData.map(row => {
                const bib = row[COL.BIB] || '';
                const processed = [...row]; // Create a mutable copy
                const l1BotMs = getTimeMs(row[COL.LOOP1_BOTTOM]); const l1TopMs = getTimeMs(row[COL.LOOP1_TOP]);
                const l2BotMs = getTimeMs(row[COL.LOOP2_BOTTOM]); const l2TopMs = getTimeMs(row[COL.LOOP2_TOP]);
                const l3BotMs = getTimeMs(row[COL.LOOP3_BOTTOM]); const l3TopMs = getTimeMs(row[COL.LOOP3_TOP]);
                const redCpMs = getTimeMs(row[COL.RED_CP]); const finishScanMs = getTimeMs(row[COL.FINISH_SCAN]);
                processed[COL.LOOP1_ELAPSED] = (l1BotMs && l1TopMs && l1TopMs > l1BotMs) ? (l1TopMs - l1BotMs) : null;
                processed[COL.DESC1_ELAPSED] = (l1TopMs && l2BotMs && l2BotMs > l1TopMs) ? (l2BotMs - l1TopMs) : null;
                processed[COL.LOOP2_ELAPSED] = (l2BotMs && l2TopMs && l2TopMs > l2BotMs) ? (l2TopMs - l2BotMs) : null;
                processed[COL.DESC2_ELAPSED] = (l2TopMs && l3BotMs && l3BotMs > l2TopMs) ? (l3BotMs - l2TopMs) : null;
                processed[COL.LOOP3_ELAPSED] = (l3BotMs && l3TopMs && l3TopMs > l3BotMs) ? (l3TopMs - l3BotMs) : null;
                processed[COL.DESC3_ELAPSED] = (l3TopMs && redCpMs && redCpMs > l3TopMs) ? (redCpMs - l3TopMs) : null;
                let totalElapsedMs = null;
                if (finishScanMs && finishScanMs > RACE_START_TIME_MS) { totalElapsedMs = finishScanMs - RACE_START_TIME_MS; }
                processed[COL.FINISH_ELAPSED] = totalElapsedMs; // Store calculated ms
                // console.log(`Bib ${bib}: FinishScanStr="${row[COL.FINISH_SCAN]}", FinishMs=${finishScanMs}, StartMs=${RACE_START_TIME_MS}, CalculatedTotalMs=${totalElapsedMs}`); // Keep for debug
                return processed;
            });
        }

        // (filterAndSortData remains the same)
        function filterAndSortData() { let filteredData = calculatedData; if (currentFilter) { const lowerCaseFilter = currentFilter.toLowerCase(); filteredData = calculatedData.filter(row => { const bib = String(row[COL.BIB] || '').toLowerCase(); const name = String(row[COL.NAME] || '').toLowerCase(); return bib.includes(lowerCaseFilter) || name.includes(lowerCaseFilter); }); } const { column, direction } = currentSort; const sortMultiplier = direction === 'asc' ? 1 : -1; filteredData.sort((a, b) => { let valA = a[COL[column.toUpperCase()]]; let valB = b[COL[column.toUpperCase()]]; if (column === 'bib') { valA = parseInt(valA || '0', 10); valB = parseInt(valB || '0', 10); } else if (column.includes('_cp') || column.includes('_scan')) { valA = getTimeMs(valA) ?? (direction === 'asc' ? Infinity : -Infinity); valB = getTimeMs(valB) ?? (direction === 'asc' ? Infinity : -Infinity); } else if (column.includes('_elapsed')) { valA = valA ?? (direction === 'asc' ? Infinity : -Infinity); valB = valB ?? (direction === 'asc' ? Infinity : -Infinity); } else { valA = String(valA || '').toLowerCase(); valB = String(valB || '').toLowerCase(); } if (valA < valB) return -1 * sortMultiplier; if (valA > valB) return 1 * sortMultiplier; return 0; }); return filteredData; }

        // --- UI Update Functions ---
        // ****** UPDATED updateTable to use correct indices ******
        function updateTable() {
            const displayData = filterAndSortData();
            resultsBody.innerHTML = '';
            if (!displayData || displayData.length === 0) { resultsBody.innerHTML = `<tr><td colspan="22" class="text-center text-gray-500 py-4">${currentFilter ? 'No matching runners found.' : 'No results data available yet.'}</td></tr>`; rowCountElement.textContent = `Showing 0 runners`; return; }

            displayData.forEach(row => {
                const tr = document.createElement('tr');
                // Use formatMillisecondsToDuration for all calculated elapsed/descent times
                // Ensure we are accessing the correct index from the 'processed' row array
                tr.innerHTML = `
                    <td>${row[COL.BIB] || ''}</td>
                    <td>${row[COL.NAME] || ''}</td>
                    <td><span class="${getStatusClass(row[COL.STATUS] || 'Active')}">${row[COL.STATUS] || 'Active'}</span></td>
                    <td>${formatTime(row[COL.GREEN_CP])}</td>
                    <td>${createLoopSpan(row[COL.LOOP1_COLOR])}</td>
                    <td>${formatTime(row[COL.LOOP1_BOTTOM])}</td>
                    <td>${formatTime(row[COL.LOOP1_TOP])}</td>
                    <td>${formatMillisecondsToDuration(row[COL.LOOP1_ELAPSED], 'LOOP1_ELAPSED')}</td>
                    <td>${formatMillisecondsToDuration(row[COL.DESC1_ELAPSED], 'DESC1_ELAPSED')}</td>
                    <td>${createLoopSpan(row[COL.LOOP2_COLOR])}</td>
                    <td>${formatTime(row[COL.LOOP2_BOTTOM])}</td>
                    <td>${formatTime(row[COL.LOOP2_TOP])}</td>
                    <td>${formatMillisecondsToDuration(row[COL.LOOP2_ELAPSED], 'LOOP2_ELAPSED')}</td>
                    <td>${formatMillisecondsToDuration(row[COL.DESC2_ELAPSED], 'DESC2_ELAPSED')}</td>
                    <td>${createLoopSpan(row[COL.LOOP3_COLOR])}</td>
                    <td>${formatTime(row[COL.LOOP3_BOTTOM])}</td>
                    <td>${formatTime(row[COL.LOOP3_TOP])}</td>
                    <td>${formatMillisecondsToDuration(row[COL.LOOP3_ELAPSED], 'LOOP3_ELAPSED')}</td>
                    <td>${formatMillisecondsToDuration(row[COL.DESC3_ELAPSED], 'DESC3_ELAPSED')}</td>
                    <td>${formatTime(row[COL.RED_CP])}</td>
                    <td>${formatTime(row[COL.FINISH_SCAN])}</td>
                    <td>${formatMillisecondsToDuration(row[COL.FINISH_ELAPSED], 'FINISH_ELAPSED')}</td>
                `;
                resultsBody.appendChild(tr);
            });
             rowCountElement.textContent = `Showing ${displayData.length} of ${calculatedData.length} runners`;
        }
        // ****** END UPDATED updateTable ******

        function updateSortIcons() { tableHeaders.forEach(th => { const sortKey = th.getAttribute('data-sort'); th.classList.remove('sort-asc', 'sort-desc'); const iconSpan = th.querySelector('.sort-icon'); if (iconSpan) iconSpan.textContent = ''; if (sortKey === currentSort.column) { th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc'); if (iconSpan) iconSpan.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼'; } }); }

        // --- Event Handlers ---
        function handleSortClick(event) { const clickedHeader = event.currentTarget; const sortKey = clickedHeader.getAttribute('data-sort'); if (!sortKey) return; if (currentSort.column === sortKey) { currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; } else { currentSort.column = sortKey; currentSort.direction = 'asc'; } console.log(`Sorting by ${currentSort.column}, direction ${currentSort.direction}`); updateTable(); updateSortIcons(); }
        function handleFilterInput() { currentFilter = searchInput.value.trim(); console.log(`Filtering by: ${currentFilter}`); updateTable(); }

        // --- Data Fetching ---
        // (fetchData remains the same - calls processData)
        async function fetchData() { if (isFetching) { console.log("Fetch already in progress, skipping."); return; } isFetching = true; console.log("Fetching data..."); if (loadingSpinner) loadingSpinner.classList.remove('hidden'); errorMessage.classList.add('hidden'); if (!SPREADSHEET_URL || SPREADSHEET_URL === 'YOUR_PUBLISHED_50K_RESULTS_CSV_URL_HERE') { console.error("Spreadsheet URL is not configured."); errorMessage.textContent = "Error: Spreadsheet URL not configured."; errorDetails.textContent = ""; errorMessage.classList.remove('hidden'); loadingMessage.classList.add('hidden'); resultsTableContainer.classList.remove('hidden'); isFetching = false; if (loadingSpinner) loadingSpinner.classList.add('hidden'); return; } try { const url = `${SPREADSHEET_URL}&t=${Date.now()}`; const response = await fetch(url); if (!response.ok) throw new Error(`Network response error: ${response.status} ${response.statusText}`); const csvData = await response.text(); allData = parseCSV(csvData); calculatedData = processData(allData); updateTable(); updateSortIcons(); resultsTableContainer.classList.remove('hidden'); loadingMessage.classList.add('hidden'); errorMessage.classList.add('hidden'); lastUpdatedElement.textContent = new Date().toLocaleTimeString(); } catch (error) { console.error('Error fetching/processing data:', error); errorMessage.textContent = "Error loading results. Displaying previous data."; errorDetails.textContent = `Details: ${error.message}`; errorMessage.classList.remove('hidden'); } finally { isFetching = false; if (loadingSpinner) loadingSpinner.classList.add('hidden'); } }

        // --- Initial Setup ---
        searchInput.addEventListener('input', handleFilterInput);
        tableHeaders.forEach(th => th.addEventListener('click', handleSortClick));
        fetchData(); // Initial fetch
        if (REFRESH_INTERVAL_MS > 0) { refreshIntervalId = setInterval(fetchData, REFRESH_INTERVAL_MS); console.log(`Auto-refresh enabled every ${REFRESH_INTERVAL_MS / 1000} seconds.`); }

    </script>

</body>
</html>
